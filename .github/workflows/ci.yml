name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-features:
    name: Feature Tests (JSON Format)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Run feature tests
        run: |
          echo "Testing features from ./tests/test_features.py..."
          python3 tests/test_features.py
          
          if [ $? -eq 0 ]; then
            echo "✅ All feature tests passed"
          else
            echo "❌ Some tests failed"
            exit 1
          fi

  test-simple:
    name: Simple Smoke Test
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Run simple test
        run: |
          echo "Running simple test..."
          chmod +x tests/simple-test.sh
          bash tests/simple-test.sh
          
          if [ $? -eq 0 ]; then
            echo "✅ Simple test passed"
          else
            echo "❌ Simple test failed"
            exit 1
          fi

  test-comprehensive:
    name: Comprehensive Tests
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Run comprehensive tests
        run: |
          echo "Running comprehensive test suite..."
          chmod +x tests/test-git-pm.sh
          bash tests/test-git-pm.sh all
          
          if [ $? -eq 0 ]; then
            echo "✅ All comprehensive tests passed"
          else
            echo "❌ Some tests failed"
            exit 1
          fi

  test-config-merging:
    name: Config Merging Tests
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Test config precedence
        run: |
          echo "Testing 3-way config merging..."
          
          mkdir -p test-config
          cd test-config
          cp ../git-pm.py .
          
          # User config
          mkdir -p ~/.git-pm
          cat > ~/.git-pm/config << 'EOF'
          {
              "packages_dir": "vendor",
              "cache_dir": "/tmp/cache"
          }
          EOF
          
          # Project config
          cat > git-pm.config << 'EOF'
          {
              "packages_dir": ".deps"
          }
          EOF
          
          # Manifest
          cat > git-pm.json << 'EOF'
          {
              "packages": {}
          }
          EOF
          
          git init
          git config user.email "test@test.com"
          git config user.name "Test User"
          
          python3 git-pm.py install --help > /dev/null 2>&1 || true
          
          echo "✅ Config merging test completed"
          rm -f ~/.git-pm/config

  test-local-overrides:
    name: Local Overrides (New Schema)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Test new schema
        run: |
          echo "Testing local override new schema..."
          
          mkdir -p test-override/{project,local-pkg}
          cd test-override/project
          cp ../../git-pm.py .
          
          echo "test" > ../local-pkg/test.txt
          
          cat > git-pm.json << 'EOF'
          {
              "packages": {
                  "pkg": {
                      "repo": "github.com/remote/repo",
                      "ref": {"type": "tag", "value": "v1.0.0"}
                  }
              }
          }
          EOF
          
          cat > git-pm.local << EOF
          {
              "packages": {
                  "pkg": {
                      "repo": "file://$(pwd)/../local-pkg"
                  }
              }
          }
          EOF
          
          git init
          git config user.email "test@test.com"
          git config user.name "Test User"
          
          python3 git-pm.py install
          
          if [ -f ".git-packages/pkg/test.txt" ]; then
            echo "✅ Local override works"
          else
            echo "❌ Override failed"
            exit 1
          fi

  test-remove-command:
    name: Remove Command (Deep Nested Dependencies)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Test deep nested removal and preservation
        run: |
          echo "Testing remove command with deep nested dependencies..."
          
          TEST_DIR="test-remove-nested"
          mkdir -p "$TEST_DIR"
          cd "$TEST_DIR"
          cp ../git-pm.py .
          
          echo "Creating package structure with deep nesting..."
          
          # Create package directories
          # Dependency tree:
          #   project → pkg-a, pkg-x
          #   pkg-a → pkg-b, pkg-c
          #   pkg-b → pkg-d
          #   pkg-c → pkg-d
          #   pkg-x → pkg-d
          
          mkdir -p packages/{pkg-a,pkg-b,pkg-c,pkg-d,pkg-x}
          
          # pkg-d (no dependencies - leaf node)
          cat > packages/pkg-d/git-pm.json << 'PKGD'
          {
              "packages": {}
          }
          PKGD
          echo "pkg-d content" > packages/pkg-d/README.md
          
          # pkg-c (depends on pkg-d)
          cat > packages/pkg-c/git-pm.json << 'PKGC'
          {
              "packages": {
                  "pkg-d": {
                      "repo": "file:///tmp/mock",
                      "ref": {"type": "tag", "value": "v1.0.0"}
                  }
              }
          }
          PKGC
          echo "pkg-c content" > packages/pkg-c/README.md
          
          # pkg-b (depends on pkg-d)
          cat > packages/pkg-b/git-pm.json << 'PKGB'
          {
              "packages": {
                  "pkg-d": {
                      "repo": "file:///tmp/mock",
                      "ref": {"type": "tag", "value": "v1.0.0"}
                  }
              }
          }
          PKGB
          echo "pkg-b content" > packages/pkg-b/README.md
          
          # pkg-a (depends on pkg-b and pkg-c)
          cat > packages/pkg-a/git-pm.json << 'PKGA'
          {
              "packages": {
                  "pkg-b": {
                      "repo": "file:///tmp/mock",
                      "ref": {"type": "tag", "value": "v1.0.0"}
                  },
                  "pkg-c": {
                      "repo": "file:///tmp/mock",
                      "ref": {"type": "tag", "value": "v1.0.0"}
                  }
              }
          }
          PKGA
          echo "pkg-a content" > packages/pkg-a/README.md
          
          # pkg-x (depends on pkg-d)
          cat > packages/pkg-x/git-pm.json << 'PKGX'
          {
              "packages": {
                  "pkg-d": {
                      "repo": "file:///tmp/mock",
                      "ref": {"type": "tag", "value": "v1.0.0"}
                  }
              }
          }
          PKGX
          echo "pkg-x content" > packages/pkg-x/README.md
          
          # Initialize project
          git init
          git config user.email "test@test.com"
          git config user.name "Test User"
          
          # Create project manifest (depends on pkg-a and pkg-x)
          cat > git-pm.json << MANIFEST
          {
              "packages": {
                  "pkg-a": {
                      "repo": "file://$(pwd)/packages/pkg-a",
                      "ref": {"type": "tag", "value": "v1.0.0"}
                  },
                  "pkg-x": {
                      "repo": "file://$(pwd)/packages/pkg-x",
                      "ref": {"type": "tag", "value": "v1.0.0"}
                  }
              }
          }
          MANIFEST
          
          # Simulate installed packages (as install would create them)
          mkdir -p .git-packages/{pkg-a,pkg-b,pkg-c,pkg-d,pkg-x}
          
          for pkg in pkg-a pkg-b pkg-c pkg-d pkg-x; do
              cp packages/$pkg/README.md .git-packages/$pkg/
              if [ -f packages/$pkg/git-pm.json ]; then
                  cp packages/$pkg/git-pm.json .git-packages/$pkg/
              fi
          done
          
          # Create .git-pm.env as install would
          cat > .git-pm.env << ENVEOF
          GIT_PM_PACKAGES_DIR=$(pwd)/.git-packages
          GIT_PM_PROJECT_ROOT=$(pwd)
          GIT_PM_PACKAGE_pkg_a=$(pwd)/.git-packages/pkg-a
          GIT_PM_PACKAGE_pkg_b=$(pwd)/.git-packages/pkg-b
          GIT_PM_PACKAGE_pkg_c=$(pwd)/.git-packages/pkg-c
          GIT_PM_PACKAGE_pkg_d=$(pwd)/.git-packages/pkg-d
          GIT_PM_PACKAGE_pkg_x=$(pwd)/.git-packages/pkg-x
          ENVEOF
          
          echo "✓ Test environment created"
          echo ""
          echo "Initial state:"
          ls -1 .git-packages/
          echo ""
          
          # TEST 1: Remove pkg-a (should cascade to pkg-b and pkg-c, but keep pkg-d)
          echo "TEST 1: Removing pkg-a (deep nested removal test)"
          echo "Expected: Remove pkg-a, pkg-b, pkg-c. Keep pkg-d (needed by pkg-x), Keep pkg-x"
          echo ""
          
          python3 git-pm.py remove pkg-a -y
          
          echo ""
          echo "Verifying deep nested removal..."
          
          # pkg-a should be removed
          if [ -d ".git-packages/pkg-a" ]; then
              echo "❌ FAIL: pkg-a still exists (should be removed)"
              exit 1
          fi
          echo "✓ pkg-a removed (explicitly requested)"
          
          # pkg-b should be removed (only needed by pkg-a)
          if [ -d ".git-packages/pkg-b" ]; then
              echo "❌ FAIL: pkg-b still exists (should be removed - only needed by pkg-a)"
              exit 1
          fi
          echo "✓ pkg-b removed (only depended on by pkg-a)"
          
          # pkg-c should be removed (only needed by pkg-a)
          if [ -d ".git-packages/pkg-c" ]; then
              echo "❌ FAIL: pkg-c still exists (should be removed - only needed by pkg-a)"
              exit 1
          fi
          echo "✓ pkg-c removed (only depended on by pkg-a)"
          
          # pkg-d should be KEPT (still needed by pkg-x)
          if [ ! -d ".git-packages/pkg-d" ]; then
              echo "❌ FAIL: pkg-d was removed (should be KEPT - needed by pkg-x)"
              exit 1
          fi
          echo "✓ pkg-d PRESERVED (still needed by pkg-x via deep nested reference)"
          
          # pkg-x should be KEPT (still in manifest)
          if [ ! -d ".git-packages/pkg-x" ]; then
              echo "❌ FAIL: pkg-x was removed (should be KEPT)"
              exit 1
          fi
          echo "✓ pkg-x PRESERVED (still in manifest)"
          
          # Check manifest
          if grep -q "pkg-a" git-pm.json; then
              echo "❌ FAIL: pkg-a still in git-pm.json"
              exit 1
          fi
          echo "✓ pkg-a removed from git-pm.json"
          
          # Check .git-pm.env
          if grep -q "pkg_a" .git-pm.env; then
              echo "❌ FAIL: pkg-a still in .git-pm.env"
              exit 1
          fi
          echo "✓ pkg-a removed from .git-pm.env"
          
          if grep -q "pkg_b" .git-pm.env; then
              echo "❌ FAIL: pkg-b still in .git-pm.env"
              exit 1
          fi
          echo "✓ pkg-b removed from .git-pm.env"
          
          if grep -q "pkg_c" .git-pm.env; then
              echo "❌ FAIL: pkg-c still in .git-pm.env"
              exit 1
          fi
          echo "✓ pkg-c removed from .git-pm.env"
          
          if ! grep -q "pkg_d" .git-pm.env; then
              echo "❌ FAIL: pkg-d removed from .git-pm.env (should be kept)"
              exit 1
          fi
          echo "✓ pkg-d preserved in .git-pm.env"
          
          if ! grep -q "pkg_x" .git-pm.env; then
              echo "❌ FAIL: pkg-x removed from .git-pm.env (should be kept)"
              exit 1
          fi
          echo "✓ pkg-x preserved in .git-pm.env"
          
          echo ""
          echo "Final state after removing pkg-a:"
          ls -1 .git-packages/
          echo ""
          
          # TEST 2: Now remove pkg-x (should also remove pkg-d since nothing needs it)
          echo "TEST 2: Removing pkg-x (should now remove pkg-d too)"
          echo "Expected: Remove pkg-x and pkg-d (no longer needed by anything)"
          echo ""
          
          python3 git-pm.py remove pkg-x -y
          
          echo ""
          echo "Verifying final removal..."
          
          # pkg-x should be removed
          if [ -d ".git-packages/pkg-x" ]; then
              echo "❌ FAIL: pkg-x still exists"
              exit 1
          fi
          echo "✓ pkg-x removed"
          
          # pkg-d should now be removed (no longer needed)
          if [ -d ".git-packages/pkg-d" ]; then
              echo "❌ FAIL: pkg-d still exists (should be removed - no longer needed)"
              exit 1
          fi
          echo "✓ pkg-d removed (no longer needed by any package)"
          
          # .git-packages should be empty or only contain empty directories
          if [ "$(ls -A .git-packages 2>/dev/null)" ]; then
              echo "❌ FAIL: .git-packages not empty"
              ls -la .git-packages/
              exit 1
          fi
          echo "✓ .git-packages is empty (all packages removed)"
          
          echo ""
          echo "=========================================="
          echo "✅ All deep nested dependency tests passed!"
          echo "=========================================="
          echo ""
          echo "Verified:"
          echo "  ✓ Deep nested packages removed when parent removed"
          echo "  ✓ Shared dependencies preserved when other packages need them"
          echo "  ✓ Cascade removal works through multiple levels"
          echo "  ✓ Manifest and environment files updated correctly"
          echo "  ✓ No packages remain when all references removed"

  test-config-command:
    name: Config Command Tests
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Run comprehensive config test suite
        run: |
          echo "============================================"
          echo "Running comprehensive config command tests"
          echo "============================================"
          echo ""
          
          # Run the comprehensive test suite
          chmod +x tests/test-config-command.sh
          bash tests/test-config-command.sh
          
          echo ""
          echo "✅ Comprehensive test suite passed"
          echo ""
      
      - name: Test config command specific requirements
        run: |
          echo "============================================"
          echo "Testing specific config command requirements"
          echo "============================================"
          echo ""
          
          # Setup test environment
          TEST_DIR="config-ci-test"
          mkdir -p "$TEST_DIR"
          cd "$TEST_DIR"
          
          # Backup user config if it exists
          if [ -f ~/.git-pm/config ]; then
            cp ~/.git-pm/config ~/.git-pm/config.ci-backup
            echo "✓ Backed up existing user config"
          fi
          
          # Remove user config for clean test
          rm -f ~/.git-pm/config
          
          # Copy git-pm.py
          cp ../git-pm.py .
          
          # Initialize minimal project
          cat > git-pm.json << 'EOF'
          {
              "packages": {}
          }
          EOF
          
          git init
          git config user.email "ci@test.com"
          git config user.name "CI Test"
          
          echo "✓ Test environment ready"
          echo ""
          
          # TEST 1: Set at project level
          echo "TEST 1: Set at project level"
          python3 git-pm.py config packages_dir ".ci-deps" > /dev/null 2>&1
          
          if [ -f "git-pm.config" ]; then
            if grep -q ".ci-deps" git-pm.config; then
              echo "✅ Set at project level works"
            else
              echo "❌ Project config doesn't contain expected value"
              exit 1
            fi
          else
            echo "❌ Project config file not created"
            exit 1
          fi
          echo ""
          
          # TEST 2: Get at project level
          echo "TEST 2: Get at project level"
          VALUE=$(python3 git-pm.py config packages_dir)
          if [ "$VALUE" = ".ci-deps" ]; then
            echo "✅ Get at project level works"
          else
            echo "❌ Expected '.ci-deps', got: $VALUE"
            exit 1
          fi
          echo ""
          
          # TEST 3: Set at global level
          echo "TEST 3: Set at global level"
          python3 git-pm.py config --global cache_dir "/tmp/ci-cache" > /dev/null 2>&1
          
          if [ -f ~/.git-pm/config ]; then
            if grep -q "/tmp/ci-cache" ~/.git-pm/config; then
              echo "✅ Set at global level works"
            else
              echo "❌ User config doesn't contain expected value"
              exit 1
            fi
          else
            echo "❌ User config file not created"
            exit 1
          fi
          echo ""
          
          # TEST 4: Get at global level
          echo "TEST 4: Get at global level"
          VALUE=$(python3 git-pm.py config cache_dir)
          if [ "$VALUE" = "/tmp/ci-cache" ]; then
            echo "✅ Get at global level works"
          else
            echo "❌ Expected '/tmp/ci-cache', got: $VALUE"
            exit 1
          fi
          echo ""
          
          # TEST 5: List shows defaults, project, and user values
          echo "TEST 5: List shows defaults, project, and user values"
          OUTPUT=$(python3 git-pm.py config --list)
          
          # Check for default values
          if echo "$OUTPUT" | grep -q "(default)"; then
            echo "  ✓ Shows default values"
          else
            echo "  ❌ Doesn't show default values"
            exit 1
          fi
          
          # Check for project values
          if echo "$OUTPUT" | grep -q "(project)"; then
            echo "  ✓ Shows project values"
          else
            echo "  ❌ Doesn't show project values"
            exit 1
          fi
          
          # Check for user values
          if echo "$OUTPUT" | grep -q "(user)"; then
            echo "  ✓ Shows user values"
          else
            echo "  ❌ Doesn't show user values"
            exit 1
          fi
          
          echo "✅ List shows all value types (default, project, user)"
          echo ""
          
          # TEST 6: List shows source of value
          echo "TEST 6: List shows source of value"
          OUTPUT=$(python3 git-pm.py config --list)
          
          # Check that packages_dir shows as project source
          if echo "$OUTPUT" | grep "packages_dir=" | grep -q "(project)"; then
            echo "  ✓ Shows project source for project-level value"
          else
            echo "  ❌ Doesn't show correct source for project value"
            exit 1
          fi
          
          # Check that cache_dir shows as user source
          if echo "$OUTPUT" | grep "cache_dir=" | grep -q "(user)"; then
            echo "  ✓ Shows user source for user-level value"
          else
            echo "  ❌ Doesn't show correct source for user value"
            exit 1
          fi
          
          # Check that a default value shows as default source
          if echo "$OUTPUT" | grep "git_protocol=" | grep -q "(default)"; then
            echo "  ✓ Shows default source for default value"
          else
            echo "  ❌ Doesn't show correct source for default value"
            exit 1
          fi
          
          echo "✅ List correctly shows source of each value"
          echo ""
          
          # TEST 7: Unset at project level
          echo "TEST 7: Unset at project level"
          python3 git-pm.py config --unset packages_dir > /dev/null 2>&1
          
          # Check that it's removed from project config
          if grep -q "packages_dir" git-pm.config 2>/dev/null; then
            echo "❌ Value still in project config after unset"
            exit 1
          else
            echo "  ✓ Removed from project config"
          fi
          
          # Check that value falls back to default
          VALUE=$(python3 git-pm.py config packages_dir)
          if [ "$VALUE" = ".git-packages" ]; then
            echo "  ✓ Falls back to default after unset"
          else
            echo "  ❌ Didn't fall back to default, got: $VALUE"
            exit 1
          fi
          
          echo "✅ Unset at project level works"
          echo ""
          
          # TEST 8: Unset at global level
          echo "TEST 8: Unset at global level"
          python3 git-pm.py config --unset --global cache_dir > /dev/null 2>&1
          
          # Check that it's removed from user config
          if grep -q "cache_dir" ~/.git-pm/config 2>/dev/null; then
            echo "❌ Value still in user config after unset"
            exit 1
          else
            echo "  ✓ Removed from user config"
          fi
          
          # Check that value falls back to default
          VALUE=$(python3 git-pm.py config cache_dir)
          EXPECTED="$HOME/.cache/git-pm"
          if [ "$VALUE" = "$EXPECTED" ]; then
            echo "  ✓ Falls back to default after unset"
          else
            echo "  ❌ Didn't fall back to default, got: $VALUE"
            exit 1
          fi
          
          echo "✅ Unset at global level works"
          echo ""
          
          # Cleanup and restore
          cd ..
          rm -rf "$TEST_DIR"
          
          # Restore original user config if it existed
          if [ -f ~/.git-pm/config.ci-backup ]; then
            mv ~/.git-pm/config.ci-backup ~/.git-pm/config
            echo "✓ Restored original user config"
          else
            rm -f ~/.git-pm/config
            echo "✓ Cleaned up test user config"
          fi
          
          echo ""
          echo "=========================================="
          echo "✅ All specific requirements tested!"
          echo "=========================================="
          echo ""
          echo "Test results:"
          echo "  ✓ Set at project level"
          echo "  ✓ Get at project level"
          echo "  ✓ Set at global level"
          echo "  ✓ Get at global level"
          echo "  ✓ List shows defaults, project, and user values"
          echo "  ✓ List shows source of each value"
          echo "  ✓ Unset at project level"
          echo "  ✓ Unset at global level"

  test-python-versions:
    name: Python ${{ matrix.python-version }}
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Test compatibility
        run: |
          echo "Testing Python ${{ matrix.python-version }}..."
          
          python git-pm.py --version
          
          mkdir test-py
          cd test-py
          
          cat > git-pm.json << 'EOF'
          {"packages": {}}
          EOF
          
          python ../git-pm.py install --help
          echo "✅ Compatible with Python ${{ matrix.python-version }}"

  test-windows:
    name: Windows Compatibility
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Test Windows
        shell: powershell
        run: |
          Write-Host "Testing Windows..."
          
          python git-pm.py --version
          
          New-Item -ItemType Directory -Path test-win -Force | Out-Null
          Set-Location test-win
          
          $manifest = @'
          {"packages": {}}
          '@
          Set-Content -Path "git-pm.json" -Value $manifest
          
          python ..\git-pm.py install --help
          Write-Host "✅ Windows compatible"

  lint-and-syntax:
    name: Lint & Syntax
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Check syntax
        run: |
          python -m py_compile git-pm.py
          echo "✅ Syntax valid"
      
      - name: Check YAML removal
        run: |
          if grep -q "SimpleYAML" git-pm.py; then
            echo "❌ SimpleYAML still present"
            exit 1
          fi
          echo "✅ YAML code removed"
      
      - name: Verify refactoring
        run: |
          if ! grep -q "_deep_merge" git-pm.py; then
            echo "❌ Config merging missing"
            exit 1
          fi
          
          if grep -q "def cmd_verify" git-pm.py; then
            echo "❌ Verify command still present (should be removed)"
            exit 1
          fi
          
          if grep -q "install_from_lockfile" git-pm.py; then
            echo "❌ Lockfile features still present (should be removed)"
            exit 1
          fi
          
          echo "✅ Refactoring verified (lockfile removed, core features intact)"
      
      - name: Check shebang
        run: |
          if head -n 1 git-pm.py | grep -q "^#!/usr/bin/env python3"; then
            echo "✅ Shebang correct"
          else
            echo "❌ Shebang incorrect"
            exit 1
          fi
      
      - name: Verify test structure
        run: |
          if [ -d "tests" ]; then
            echo "✅ tests/ directory exists"
          else
            echo "❌ tests/ directory missing"
            exit 1
          fi
          
          for file in tests/test_features.py tests/simple-test.sh tests/test-git-pm.sh; do
            if [ -f "$file" ]; then
              echo "✅ $file exists"
            else
              echo "❌ $file missing"
              exit 1
            fi
          done