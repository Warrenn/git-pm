name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-features:
    name: Feature Tests (JSON Format)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Run feature tests
        run: |
          echo "Testing features from ./tests/test_features.py..."
          python3 tests/test_features.py
          
          if [ $? -eq 0 ]; then
            echo "✅ All feature tests passed"
          else
            echo "❌ Some tests failed"
            exit 1
          fi

  test-simple:
    name: Simple Smoke Test
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Run simple test
        run: |
          echo "Running simple test..."
          chmod +x tests/simple-test.sh
          bash tests/simple-test.sh
          
          if [ $? -eq 0 ]; then
            echo "✅ Simple test passed"
          else
            echo "❌ Simple test failed"
            exit 1
          fi

  test-comprehensive:
    name: Comprehensive Tests
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Run comprehensive tests
        run: |
          echo "Running comprehensive test suite..."
          chmod +x tests/test-git-pm.sh
          bash tests/test-git-pm.sh all
          
          if [ $? -eq 0 ]; then
            echo "✅ All comprehensive tests passed"
          else
            echo "❌ Some tests failed"
            exit 1
          fi

  test-config-merging:
    name: Config Merging Tests
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Test config precedence
        run: |
          echo "Testing 3-way config merging..."
          
          mkdir -p test-config
          cd test-config
          cp ../git-pm.py .
          
          # User config
          mkdir -p ~/.git-pm
          cat > ~/.git-pm/config << 'EOF'
          {
              "packages_dir": "vendor",
              "cache_dir": "/tmp/cache"
          }
          EOF
          
          # Project config
          cat > git-pm.config << 'EOF'
          {
              "packages_dir": ".deps"
          }
          EOF
          
          # Manifest
          cat > git-pm.json << 'EOF'
          {
              "packages": {}
          }
          EOF
          
          git init
          git config user.email "test@test.com"
          git config user.name "Test User"
          
          python3 git-pm.py list > /dev/null 2>&1 || true
          
          echo "✅ Config merging test completed"
          rm -f ~/.git-pm/config

  test-lockfile:
    name: Lockfile Features
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Test lockfile reproducibility
        run: |
          echo "Testing lockfile..."
          
          # Create mock repo
          mkdir -p test-lock/mock-repo
          cd test-lock/mock-repo
          git init
          git config user.email "test@test.com"
          git config user.name "Test User"
          echo "v1" > file.txt
          git add .
          git commit -m "v1"
          
          # Create project
          cd ..
          mkdir project
          cd project
          cp ../../git-pm.py .
          
          cat > git-pm.json << EOF
          {
              "packages": {
                  "test": {
                      "repo": "file://$(pwd)/../mock-repo",
                      "ref": {"type": "branch", "value": "main"}
                  }
              }
          }
          EOF
          
          git init
          git config user.email "test@test.com"
          git config user.name "Test User"
          
          # Install
          python3 git-pm.py install --no-resolve-deps
          
          if [ ! -f "git-pm.lock" ]; then
            echo "❌ Lockfile not created"
            exit 1
          fi
          
          python3 -c "import json; json.load(open('git-pm.lock'))"
          echo "✅ Lockfile is valid JSON"
          
          LOCKED=$(python3 -c "import json; print(json.load(open('git-pm.lock'))['packages']['test']['commit'])")
          echo "Locked: $LOCKED"
          
          python3 git-pm.py clean
          python3 git-pm.py install --no-resolve-deps
          
          NEW_LOCKED=$(python3 -c "import json; print(json.load(open('git-pm.lock'))['packages']['test']['commit'])")
          
          if [ "$LOCKED" = "$NEW_LOCKED" ]; then
            echo "✅ Reproducible build"
          else
            echo "❌ Not reproducible"
            exit 1
          fi
      
      - name: Test verify command
        run: |
          cd test-lock/project
          
          if python3 git-pm.py verify; then
            echo "✅ Verify passes"
          else
            echo "❌ Verify failed"
            exit 1
          fi
          
          rm -rf .git-packages/test
          
          if ! python3 git-pm.py verify; then
            echo "✅ Verify detects corruption"
          else
            echo "❌ Verify didn't detect corruption"
            exit 1
          fi

  test-local-overrides:
    name: Local Overrides (New Schema)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Test new schema
        run: |
          echo "Testing local override new schema..."
          
          mkdir -p test-override/{project,local-pkg}
          cd test-override/project
          cp ../../git-pm.py .
          
          echo "test" > ../local-pkg/test.txt
          
          cat > git-pm.json << 'EOF'
          {
              "packages": {
                  "pkg": {
                      "repo": "github.com/remote/repo",
                      "ref": {"type": "tag", "value": "v1.0.0"}
                  }
              }
          }
          EOF
          
          cat > git-pm.local << EOF
          {
              "packages": {
                  "pkg": {
                      "repo": "file://$(pwd)/../local-pkg"
                  }
              }
          }
          EOF
          
          git init
          git config user.email "test@test.com"
          git config user.name "Test User"
          
          python3 git-pm.py install --no-resolve-deps
          
          if [ -f ".git-packages/pkg/test.txt" ]; then
            echo "✅ Local override works"
          else
            echo "❌ Override failed"
            exit 1
          fi

  test-python-versions:
    name: Python ${{ matrix.python-version }}
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Test compatibility
        run: |
          echo "Testing Python ${{ matrix.python-version }}..."
          
          python git-pm.py --version
          
          mkdir test-py
          cd test-py
          
          cat > git-pm.json << 'EOF'
          {"packages": {}}
          EOF
          
          python ../git-pm.py list
          echo "✅ Compatible with Python ${{ matrix.python-version }}"

  test-windows:
    name: Windows Compatibility
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Test Windows
        shell: powershell
        run: |
          Write-Host "Testing Windows..."
          
          python git-pm.py --version
          
          New-Item -ItemType Directory -Path test-win -Force | Out-Null
          Set-Location test-win
          
          $manifest = @'
          {"packages": {}}
          '@
          Set-Content -Path "git-pm.json" -Value $manifest
          
          python ..\git-pm.py list
          Write-Host "✅ Windows compatible"

  lint-and-syntax:
    name: Lint & Syntax
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Check syntax
        run: |
          python -m py_compile git-pm.py
          echo "✅ Syntax valid"
      
      - name: Check YAML removal
        run: |
          if grep -q "SimpleYAML" git-pm.py; then
            echo "❌ SimpleYAML still present"
            exit 1
          fi
          echo "✅ YAML code removed"
      
      - name: Check new features
        run: |
          if ! grep -q "_deep_merge" git-pm.py; then
            echo "❌ Config merging missing"
            exit 1
          fi
          
          if ! grep -q "def cmd_verify" git-pm.py; then
            echo "❌ Verify command missing"
            exit 1
          fi
          
          if ! grep -q "install_from_lockfile" git-pm.py; then
            echo "❌ Lockfile features missing"
            exit 1
          fi
          
          echo "✅ All features present"
      
      - name: Check shebang
        run: |
          if head -n 1 git-pm.py | grep -q "^#!/usr/bin/env python3"; then
            echo "✅ Shebang correct"
          else
            echo "❌ Shebang incorrect"
            exit 1
          fi
      
      - name: Verify test structure
        run: |
          if [ -d "tests" ]; then
            echo "✅ tests/ directory exists"
          else
            echo "❌ tests/ directory missing"
            exit 1
          fi
          
          for file in tests/test_features.py tests/simple-test.sh tests/test-git-pm.sh; do
            if [ -f "$file" ]; then
              echo "✅ $file exists"
            else
              echo "❌ $file missing"
              exit 1
            fi
          done