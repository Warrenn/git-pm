name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.2.0)'
        required: true
        type: string

env:
  REPO_OWNER: ${{ github.repository_owner }}
  REPO_NAME: ${{ github.event.repository.name }}
  REPO_FULL: ${{ github.repository }}
  REPO_URL: ${{ github.server_url }}/${{ github.repository }}

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history for changelog
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          
          # Remove 'v' prefix if present
          VERSION_NUM="${VERSION#v}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (Number: $VERSION_NUM)"
      
      - name: Verify version in git-pm.py
        run: |
          SCRIPT_VERSION=$(grep -oP '__version__ = "\K[^"]+' git-pm.py)
          
          if [ "$SCRIPT_VERSION" != "${{ steps.version.outputs.version_num }}" ]; then
            echo "‚ùå Version mismatch!"
            echo "   Script version: $SCRIPT_VERSION"
            echo "   Release version: ${{ steps.version.outputs.version_num }}"
            exit 1
          fi
          
          echo "‚úÖ Version matches: $SCRIPT_VERSION"
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag"
            CHANGELOG="Initial release"
          else
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.version }}"
            
            # Generate commit log
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No changes since $PREV_TAG"
            fi
          fi
          
          # Save to file
          echo "$CHANGELOG" > changelog.txt
          
          echo "Changelog:"
          cat changelog.txt
      
      - name: Pre-release validation
        run: |
          echo "Validating git-pm.py before release..."
          
          # Check syntax
          python3 -m py_compile git-pm.py || exit 1
          echo "‚úÖ Syntax valid"
          
          # Check no lockfile code
          if grep -qi "install_from_lockfile\|save_lockfile\|load_lockfile" git-pm.py; then
            echo "‚ùå Lockfile code found (should be removed)"
            exit 1
          fi
          echo "‚úÖ No lockfile code"
          
          # Check no removed commands
          if grep -q "def cmd_update\|def cmd_list\|def cmd_verify" git-pm.py; then
            echo "‚ùå Removed commands found"
            exit 1
          fi
          echo "‚úÖ No removed commands"
          
          # Check that remove command exists (v0.3.0+)
          if ! grep -q "def cmd_remove" git-pm.py; then
            echo "‚ùå Remove command not found (required for v0.3.0+)"
            exit 1
          fi
          echo "‚úÖ Remove command present"
          
          # Check that config command exists (v0.4.0+)
          if ! grep -q "def cmd_config" git-pm.py; then
            echo "‚ùå Config command not found (required for v0.4.0+)"
            exit 1
          fi
          echo "‚úÖ Config command present"
          
          # Test basic commands
          python3 git-pm.py --version || exit 1
          python3 git-pm.py --help | grep -q "install.*clean.*remove.*config.*add" || exit 1
          echo "‚úÖ Commands work (install, clean, remove, config, add)"
          
          # Test remove command specifically
          python3 git-pm.py remove --help | grep -q "package" || exit 1
          echo "‚úÖ Remove command functional"
          
          # Test config command specifically
          python3 git-pm.py config --help | grep -q "Configuration key" || exit 1
          echo "‚úÖ Config command functional"
          
          echo "‚úÖ Pre-release validation passed"
      
      - name: Get commit statistics
        id: stats
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git rev-list ${PREV_TAG}..HEAD --count)
            FILES_CHANGED=$(git diff --name-only ${PREV_TAG}..HEAD | wc -l)
            INSERTIONS=$(git diff ${PREV_TAG}..HEAD --shortstat | grep -oP '\d+(?= insertion)')
            DELETIONS=$(git diff ${PREV_TAG}..HEAD --shortstat | grep -oP '\d+(?= deletion)')
          else
            COMMITS=$(git rev-list HEAD --count)
            FILES_CHANGED="N/A"
            INSERTIONS="N/A"
            DELETIONS="N/A"
          fi
          
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "insertions=${INSERTIONS:-0}" >> $GITHUB_OUTPUT
          echo "deletions=${DELETIONS:-0}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes
        id: notes
        run: |
          RELEASE_DATE=$(date +%Y-%m-%d)
          cat > release_notes.md << 'NOTES_EOF'
          # git-pm ${{ steps.version.outputs.version }} - Git Package Manager
          
          ## üéâ Release Information
          
          **Version:** ${{ steps.version.outputs.version }}  
          **Release Date:** RELEASE_DATE_PLACEHOLDER  
          **Repository:** [${{ env.REPO_FULL }}](${{ env.REPO_URL }})  
          **Tag:** [${{ steps.version.outputs.version }}](${{ env.REPO_URL }}/releases/tag/${{ steps.version.outputs.version }})  
          
          ## üìä Statistics
          
          - **Commits:** ${{ steps.stats.outputs.commits }}
          - **Files Changed:** ${{ steps.stats.outputs.files }}
          - **Lines Added:** ${{ steps.stats.outputs.insertions }}
          - **Lines Removed:** ${{ steps.stats.outputs.deletions }}
          
          ## ‚ú® What's New in v0.4.1
          
          ### ‚öôÔ∏è New Feature: Config Command
          
          This release adds the **`config` command** for convenient CLI-based configuration management!
          
          **New Command:**
          ```bash
          git-pm config [options]
          ```
          
          ### üéØ Key Features
          
          - ‚úÖ **Get configuration values** - Retrieve current settings
          - ‚úÖ **Set at project level** - Configure current project
          - ‚úÖ **Set at user level** - Configure globally with --global
          - ‚úÖ **Unset values** - Remove configuration settings
          - ‚úÖ **List all settings** - View merged configuration with sources
          - ‚úÖ **Auto-create files** - Creates config files automatically
          - ‚úÖ **Key validation** - Prevents typos with helpful errors
          - ‚úÖ **Source indicators** - Shows where each value comes from
          
          ### üìñ How It Works
          
          **Configuration Levels (Priority Order):**
          1. **Project config** (`git-pm.config`) - Highest priority
          2. **User config** (`~/.git-pm/config`) - Medium priority
          3. **Defaults** (built-in) - Lowest priority
          
          ### üîß Config Command Usage
          
          **Get a value:**
          ```bash
          $ git-pm config packages_dir
          .git-packages
          ```
          
          **Set at project level:**
          ```bash
          $ git-pm config packages_dir ".deps"
          ‚úì Set packages_dir = .deps in project config
          ```
          
          **Set at user level (--global):**
          ```bash
          $ git-pm config --global cache_dir "/tmp/cache"
          ‚úì Set cache_dir = /tmp/cache in user config
          ```
          
          **List all settings with sources:**
          ```bash
          $ git-pm config --list
          ‚öôÔ∏è  git-pm config
          
          Configuration (merged view):
          
          azure_devops_pat=(empty) (default)
          cache_dir=/tmp/cache (user)
          git_protocol={} (default)
          packages_dir=.deps (project)
          url_patterns={} (default)
          ```
          
          **Unset a value:**
          ```bash
          $ git-pm config --unset packages_dir
          ‚úì Unset packages_dir in project config
          
          # Falls back to user or default value
          $ git-pm config packages_dir
          .git-packages
          ```
          
          ### üìã Config Command Options
          
          | Command | Description |
          |---------|-------------|
          | `config <key>` | Get value (shows merged result) |
          | `config <key> <value>` | Set value (project level) |
          | `config --global <key> <value>` | Set value (user level) |
          | `config --unset <key>` | Unset value (project level) |
          | `config --unset --global <key>` | Unset value (user level) |
          | `config --list` | List all settings with sources |
          
          ### üîë Configuration Keys
          
          | Key | Description | Default |
          |-----|-------------|---------|
          | `packages_dir` | Where packages install | `.git-packages` |
          | `cache_dir` | Cache location | `~/.cache/git-pm` |
          | `git_protocol` | Git protocol settings | `{}` |
          | `url_patterns` | URL mappings | `{}` |
          | `azure_devops_pat` | Azure PAT token | `""` |
          
          ### üìö Example Scenarios
          
          **Change install directory:**
          ```bash
          git-pm config packages_dir ".modules"
          ```
          
          **Use SSD for cache:**
          ```bash
          git-pm config --global cache_dir "/mnt/ssd/git-pm-cache"
          ```
          
          **Review all settings:**
          ```bash
          git-pm config --list
          ```
          
          **Reset to defaults:**
          ```bash
          git-pm config --unset packages_dir
          git-pm config --unset --global packages_dir
          ```
          
          ## üöÄ Quick Start
          
          ### Available Commands (Updated for v0.4.1)
          
          ```bash
          git-pm install [--no-gitignore]    # Install packages with dependency resolution
          git-pm clean                        # Remove all installed packages
          git-pm remove <pkg> [-y]            # Remove specific package
          git-pm config [options]             # Manage configuration (NEW!)
          git-pm add <n> <repo> [opts]        # Add package to manifest
          ```
          
          ### Example Usage
          
          ```bash
          # Configure packages directory
          git-pm config packages_dir ".deps"
          
          # Add a package (JSON format)
          git-pm add utils github.com/company/monorepo \
            --path packages/utils \
            --ref-type tag \
            --ref-value v1.0.0
          
          # Install with automatic dependency resolution
          git-pm install
          
          # List configuration
          git-pm config --list
          
          # Remove a specific package
          git-pm remove utils -y
          
          # Clean all packages
          git-pm clean
          ```
          
          ## üìã Manifest Format (JSON)
          
          ```json
          {
            "packages": {
              "azure-bootstrap": {
                "repo": "dev.azure.com/org/terraform",
                "path": "modules/bootstrap",
                "ref": {
                  "type": "tag",
                  "value": "v1.0.0"
                }
              },
              "common-utils": {
                "repo": "github.com/company/shared-libs",
                "path": "utils",
                "ref": {
                  "type": "branch",
                  "value": "main"
                }
              }
            }
          }
          ```
          
          ## üìö Core Features (Complete Set)
          
          ‚úÖ **Dependency Resolution** - Automatic recursive discovery  
          ‚úÖ **Explicit Versioning** - Tags, branches, or commits  
          ‚úÖ **Configuration Management** - CLI config with precedence (NEW!)  
          ‚úÖ **Package Removal** - Smart cascade with preservation  
          ‚úÖ **Local Overrides** - Fast development with `git-pm.local`  
          ‚úÖ **Smart Caching** - Fast repeated installs  
          ‚úÖ **Cross-Platform** - Linux, macOS, Windows  
          ‚úÖ **Zero Dependencies** - Pure Python 3.8+  
          ‚úÖ **Azure DevOps PAT** - Built-in token support  
          
          ## üìã Requirements
          
          - Python 3.8+
          - Git 2.25+
          - Internet connection (for remote repos)
          
          ## üéì Examples
          
          ### Terraform Modules
          ```json
          {
            "packages": {
              "azure-bootstrap": {
                "repo": "dev.azure.com/org/terraform",
                "path": "modules/bootstrap",
                "ref": {"type": "tag", "value": "v1.0.0"}
              }
            }
          }
          ```
          
          ### Shared Libraries
          ```json
          {
            "packages": {
              "common-utils": {
                "repo": "github.com/company/shared-libs",
                "path": "utils",
                "ref": {"type": "branch", "value": "main"}
              }
            }
          }
          ```
          
          ### Bitbucket Support
          ```json
          {
            "packages": {
              "my-lib": {
                "repo": "bitbucket.org/workspace/repository",
                "path": "packages/my-lib",
                "ref": {"type": "tag", "value": "v1.0.0"}
              }
            }
          }
          ```
          
          ## üîÑ Previous Release (v0.3.0)
          
          v0.3.0 added the remove command with intelligent dependency management:
          - **`remove` command** - Smart cascade removal
          - Deep recursion analysis (3+ levels)
          - Preserves shared dependencies
          - Multi-path detection
          - Dual manifest support (git-pm.json + git-pm.local)
          - Environment file cleanup
          - Preview before removal
          - Safe by design (no --force flag)
          
          ## üôè Feedback
          
          Please report issues at: [${{ env.REPO_FULL }}/issues](${{ env.REPO_URL }}/issues)
          
          ---
          
          **Released by:** @${{ github.actor }}  
          **Commit:** [${{ github.sha }}](${{ env.REPO_URL }}/commit/${{ github.sha }})
          NOTES_EOF
          
          # Replace the date placeholder with actual date
          sed -i "s/RELEASE_DATE_PLACEHOLDER/$RELEASE_DATE/g" release_notes.md
          
          echo "Release notes generated:"
          cat release_notes.md

      - name: Prepare release assets
        id: assets
        run: |
          echo "Preparing release assets..."
          
          # Start with required files
          ASSETS="git-pm.py"
          
          # Add optional files if they exist
          [ -f "README.md" ] && ASSETS="$ASSETS README.md" || echo "‚ö†Ô∏è  README.md not found"
          [ -f "install-git-pm.sh" ] && ASSETS="$ASSETS install-git-pm.sh" || echo "‚ö†Ô∏è  install-git-pm.sh not found"
          [ -f "install-git-pm.ps1" ] && ASSETS="$ASSETS install-git-pm.ps1" || echo "‚ö†Ô∏è  install-git-pm.ps1 not found"
          
          # Create files list for GitHub release action
          echo "$ASSETS" | tr ' ' '\n' > release_assets.txt
          
          echo "Assets to upload:"
          cat release_assets.txt
          
          # Export for next step
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat release_assets.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: git-pm ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: ${{ steps.assets.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify release
        run: |
          echo "‚úÖ Release ${{ steps.version.outputs.version }} created successfully!"
          echo ""
          echo "Release URL: ${{ env.REPO_URL }}/releases/tag/${{ steps.version.outputs.version }}"
          echo ""
          echo "Installation command (Linux/macOS):"
          echo "curl -fsSL ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.sh | bash"
          echo ""
          echo "Installation command (Windows):"
          echo "irm ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.ps1 | iex"
          echo ""
          echo "Download URL:"
          echo "${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py"

  test-installation:
    name: Test Release Installation
    needs: create-release
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Wait for release to be available
        shell: bash
        run: |
          echo "Waiting for release to be available..."
          sleep 30
      
      - name: Test Linux/macOS installation
        if: runner.os != 'Windows'
        run: |
          # Test direct download
          curl -fsSL ${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py -o git-pm.py
          
          # Verify downloaded
          if [ -f git-pm.py ]; then
            echo "‚úÖ Downloaded git-pm.py"
          else
            echo "‚ùå Failed to download git-pm.py"
            exit 1
          fi
          
          # Test version
          python3 git-pm.py --version
          
          echo "‚úÖ Release installation test passed on ${{ runner.os }}"
      
      - name: Test Windows installation
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Test direct download
          Invoke-WebRequest -Uri "${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py" -OutFile git-pm.py
          
          # Verify downloaded
          if (Test-Path git-pm.py) {
            Write-Host "‚úÖ Downloaded git-pm.py"
          } else {
            Write-Host "‚ùå Failed to download git-pm.py"
            exit 1
          }
          
          # Test version
          python git-pm.py --version
          
          Write-Host "‚úÖ Release installation test passed on Windows"