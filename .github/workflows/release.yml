name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.2.0)'
        required: true
        type: string

env:
  REPO_OWNER: ${{ github.repository_owner }}
  REPO_NAME: ${{ github.event.repository.name }}
  REPO_FULL: ${{ github.repository }}
  REPO_URL: ${{ github.server_url }}/${{ github.repository }}

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history for changelog
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          
          # Remove 'v' prefix if present
          VERSION_NUM="${VERSION#v}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (Number: $VERSION_NUM)"
      
      - name: Verify version in git-pm.py
        run: |
          SCRIPT_VERSION=$(grep -oP '__version__ = "\K[^"]+' git-pm.py)
          
          if [ "$SCRIPT_VERSION" != "${{ steps.version.outputs.version_num }}" ]; then
            echo "‚ùå Version mismatch!"
            echo "   Script version: $SCRIPT_VERSION"
            echo "   Release version: ${{ steps.version.outputs.version_num }}"
            exit 1
          fi
          
          echo "‚úÖ Version matches: $SCRIPT_VERSION"
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag"
            CHANGELOG="Initial release"
          else
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.version }}"
            
            # Generate commit log
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No changes since $PREV_TAG"
            fi
          fi
          
          # Save to file
          echo "$CHANGELOG" > changelog.txt
          
          echo "Changelog:"
          cat changelog.txt
      
      - name: Pre-release validation
        run: |
          echo "Validating git-pm.py before release..."
          
          # Check syntax
          python3 -m py_compile git-pm.py || exit 1
          echo "‚úÖ Syntax valid"
          
          # Check no lockfile code
          if grep -qi "install_from_lockfile\|save_lockfile\|load_lockfile" git-pm.py; then
            echo "‚ùå Lockfile code found (should be removed)"
            exit 1
          fi
          echo "‚úÖ No lockfile code"
          
          # Check no removed commands
          if grep -q "def cmd_update\|def cmd_list\|def cmd_verify" git-pm.py; then
            echo "‚ùå Removed commands found"
            exit 1
          fi
          echo "‚úÖ No removed commands"
          
          # Test basic commands
          python3 git-pm.py --version || exit 1
          python3 git-pm.py --help | grep -q "install.*clean.*add" || exit 1
          echo "‚úÖ Commands work"
          
          echo "‚úÖ Pre-release validation passed"
      
      - name: Get commit statistics
        id: stats
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git rev-list ${PREV_TAG}..HEAD --count)
            FILES_CHANGED=$(git diff --name-only ${PREV_TAG}..HEAD | wc -l)
            INSERTIONS=$(git diff ${PREV_TAG}..HEAD --shortstat | grep -oP '\d+(?= insertion)')
            DELETIONS=$(git diff ${PREV_TAG}..HEAD --shortstat | grep -oP '\d+(?= deletion)')
          else
            COMMITS=$(git rev-list HEAD --count)
            FILES_CHANGED="N/A"
            INSERTIONS="N/A"
            DELETIONS="N/A"
          fi
          
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "insertions=${INSERTIONS:-0}" >> $GITHUB_OUTPUT
          echo "deletions=${DELETIONS:-0}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'NOTES_EOF'
          # git-pm ${{ steps.version.outputs.version }} - Git Package Manager
          
          ## üéâ Release Information
          
          **Version:** ${{ steps.version.outputs.version }}  
          **Release Date:** $(date +%Y-%m-%d)  
          **Repository:** [${{ env.REPO_FULL }}](${{ env.REPO_URL }})  
          **Tag:** [${{ steps.version.outputs.version }}](${{ env.REPO_URL }}/releases/tag/${{ steps.version.outputs.version }})  
          
          ## üìä Statistics
          
          - **Commits:** ${{ steps.stats.outputs.commits }}
          - **Files Changed:** ${{ steps.stats.outputs.files }}
          - **Lines Added:** ${{ steps.stats.outputs.insertions }}
          - **Lines Removed:** ${{ steps.stats.outputs.deletions }}
          
          ## ‚ú® What's New in v0.2.9
          
          ### üßπ Major Refactoring - Simplified & Streamlined
          
          This release removes the lockfile system and significantly simplifies git-pm while maintaining all core functionality.
          
          **Code Reduction:**
          - 23.8% smaller codebase (removed 362 lines)
          - 50% fewer commands (6 ‚Üí 3)
          - 67% fewer flags (3 ‚Üí 1)
          
          **Removed Features:**
          - ‚ùå Lockfile system (\`git-pm.lock\`) - Use commit refs for reproducibility
          - ‚ùå \`git-pm update\` command - Use \`git-pm install\` instead
          - ‚ùå \`--force-fresh\` flag - All installs are fresh now
          - ‚ùå \`--no-resolve-deps\` flag - Dependencies always resolved
          
          **What Remains (Fully Functional):**
          - ‚úÖ Full dependency resolution (always enabled)
          - ‚úÖ Tag/commit/branch references
          - ‚úÖ Local overrides (\`git-pm.local\`)
          - ‚úÖ Config management (3-way merging)
          - ‚úÖ Symlink creation
          - ‚úÖ .gitignore management (no lockfile entry)
          - ‚úÖ Environment file generation
          - ‚úÖ Windows compatibility
          - ‚úÖ Python 3.8-3.12 support
          
          ## üöÄ Quick Start
          
          ### Available Commands
          
          \`\`\`bash
          git-pm install [--no-gitignore]    # Install packages with dependency resolution
          git-pm clean                        # Remove all installed packages
          git-pm add <name> <repo> [opts]  # Add package to manifest
          \`\`\`
          
          ### Example Usage
          
          \`\`\`bash
          # Add a package (JSON format)
          git-pm add utils github.com/company/monorepo \\
            --path packages/utils \\
            --ref-type tag \\
            --ref-value v1.0.0
          
          # Install with automatic dependency resolution
          git-pm install
          
          # Clean packages
          git-pm clean
          \`\`\`
          
          ## üìã Manifest Format (JSON)
          
          \`\`\`json
          {
            "packages": {
              "azure-bootstrap": {
                "repo": "dev.azure.com/org/terraform",
                "path": "modules/bootstrap",
                "ref": {
                  "type": "tag",
                  "value": "v1.0.0"
                }
              },
              "common-utils": {
                "repo": "github.com/company/shared-libs",
                "path": "utils",
                "ref": {
                  "type": "branch",
                  "value": "main"
                }
              }
            }
          }
          \`\`\`
          
          ## üîÑ Migration Guide
          
          **For Most Users:** No changes needed! Existing manifests work as-is.
          
          **Command Changes:**
          \`\`\`bash
          # Old ‚Üí New
          git-pm update              ‚Üí git-pm install
          git-pm install --force-fresh ‚Üí git-pm install
          \`\`\`
          
          **For Reproducibility:**
          Use commit refs instead of branches:
          \`\`\`json
          {
            "ref": {
              "type": "commit",
              "value": "abc123def456"
            }
          }
          \`\`\`
          
          ## üìö Core Features
          
          ‚úÖ **Dependency Resolution** - Automatic recursive discovery  
          ‚úÖ **Explicit Versioning** - Tags, branches, or commits  
          ‚úÖ **Local Overrides** - Fast development with \`git-pm.local\`  
          ‚úÖ **Smart Caching** - Fast repeated installs  
          ‚úÖ **Cross-Platform** - Linux, macOS, Windows  
          ‚úÖ **Zero Dependencies** - Pure Python 3.8+  
          ‚úÖ **Azure DevOps PAT** - Built-in token support  
          
          ## üìã Requirements
          
          - Python 3.8+
          - Git 2.25+
          - Internet connection (for remote repos)
          
          ## üéì Examples
          
          ### Terraform Modules
          \`\`\`json
          {
            "packages": {
              "azure-bootstrap": {
                "repo": "dev.azure.com/org/terraform",
                "path": "modules/bootstrap",
                "ref": {"type": "tag", "value": "v1.0.0"}
              }
            }
          }
          \`\`\`
          
          ### Shared Libraries
          \`\`\`json
          {
            "packages": {
              "common-utils": {
                "repo": "github.com/company/shared-libs",
                "path": "utils",
                "ref": {"type": "branch", "value": "main"}
              }
            }
          }
          \`\`\`
          
          ### Bitbucket Support
          \`\`\`json
          {
            "packages": {
              "my-lib": {
                "repo": "bitbucket.org/workspace/repository",
                "path": "packages/my-lib",
                "ref": {"type": "tag", "value": "v1.0.0"}
              }
            }
          }
          \`\`\`
          
          ## üôè Feedback
          
          Please report issues at: [${{ env.REPO_FULL }}/issues](${{ env.REPO_URL }}/issues)
          
          ---
          
          **Released by:** @${{ github.actor }}  
          **Commit:** [${{ github.sha }}](${{ env.REPO_URL }}/commit/${{ github.sha }})
          NOTES_EOF
          
          echo "Release notes generated:"
          cat release_notes.md

      - name: Prepare release assets
        id: assets
        run: |
          echo "Preparing release assets..."
          
          # Start with required files
          ASSETS="git-pm.py"
          
          # Add optional files if they exist
          [ -f "README.md" ] && ASSETS="$ASSETS README.md" || echo "‚ö†Ô∏è  README.md not found"
          [ -f "install-git-pm.sh" ] && ASSETS="$ASSETS install-git-pm.sh" || echo "‚ö†Ô∏è  install-git-pm.sh not found"
          [ -f "install-git-pm.ps1" ] && ASSETS="$ASSETS install-git-pm.ps1" || echo "‚ö†Ô∏è  install-git-pm.ps1 not found"
          
          # Create files list for GitHub release action
          echo "$ASSETS" | tr ' ' '\n' > release_assets.txt
          
          echo "Assets to upload:"
          cat release_assets.txt
          
          # Export for next step
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat release_assets.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: git-pm ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: ${{ steps.assets.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify release
        run: |
          echo "‚úÖ Release ${{ steps.version.outputs.version }} created successfully!"
          echo ""
          echo "Release URL: ${{ env.REPO_URL }}/releases/tag/${{ steps.version.outputs.version }}"
          echo ""
          echo "Installation command (Linux/macOS):"
          echo "curl -fsSL ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.sh | bash"
          echo ""
          echo "Installation command (Windows):"
          echo "irm ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.ps1 | iex"
          echo ""
          echo "Download URL:"
          echo "${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py"

  test-installation:
    name: Test Release Installation
    needs: create-release
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Wait for release to be available
        shell: bash
        run: |
          echo "Waiting for release to be available..."
          sleep 30
      
      - name: Test Linux/macOS installation
        if: runner.os != 'Windows'
        run: |
          # Test direct download
          curl -fsSL ${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py -o git-pm.py
          
          # Verify downloaded
          if [ -f git-pm.py ]; then
            echo "‚úÖ Downloaded git-pm.py"
          else
            echo "‚ùå Failed to download git-pm.py"
            exit 1
          fi
          
          # Test version
          python3 git-pm.py --version
          
          echo "‚úÖ Release installation test passed on ${{ runner.os }}"
      
      - name: Test Windows installation
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Test direct download
          Invoke-WebRequest -Uri "${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py" -OutFile git-pm.py
          
          # Verify downloaded
          if (Test-Path git-pm.py) {
            Write-Host "‚úÖ Downloaded git-pm.py"
          } else {
            Write-Host "‚ùå Failed to download git-pm.py"
            exit 1
          }
          
          # Test version
          python git-pm.py --version
          
          Write-Host "‚úÖ Release installation test passed on Windows"