name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.2.0)'
        required: true
        type: string

env:
  REPO_OWNER: ${{ github.repository_owner }}
  REPO_NAME: ${{ github.event.repository.name }}
  REPO_FULL: ${{ github.repository }}
  REPO_URL: ${{ github.server_url }}/${{ github.repository }}

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history for changelog
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          
          # Remove 'v' prefix if present
          VERSION_NUM="${VERSION#v}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (Number: $VERSION_NUM)"
      
      - name: Verify version in git-pm.py
        run: |
          SCRIPT_VERSION=$(grep -oP '__version__ = "\K[^"]+' git-pm.py)
          
          if [ "$SCRIPT_VERSION" != "${{ steps.version.outputs.version_num }}" ]; then
            echo "‚ùå Version mismatch!"
            echo "   Script version: $SCRIPT_VERSION"
            echo "   Release version: ${{ steps.version.outputs.version_num }}"
            exit 1
          fi
          
          echo "‚úÖ Version matches: $SCRIPT_VERSION"
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag"
            CHANGELOG="Initial release"
          else
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.version }}"
            
            # Generate commit log
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No changes since $PREV_TAG"
            fi
          fi
          
          # Save to file
          echo "$CHANGELOG" > changelog.txt
          
          echo "Changelog:"
          cat changelog.txt
      
      - name: Get commit statistics
        id: stats
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git rev-list ${PREV_TAG}..HEAD --count)
            FILES_CHANGED=$(git diff --name-only ${PREV_TAG}..HEAD | wc -l)
            INSERTIONS=$(git diff ${PREV_TAG}..HEAD --shortstat | grep -oP '\d+(?= insertion)')
            DELETIONS=$(git diff ${PREV_TAG}..HEAD --shortstat | grep -oP '\d+(?= deletion)')
          else
            COMMITS=$(git rev-list HEAD --count)
            FILES_CHANGED="N/A"
            INSERTIONS="N/A"
            DELETIONS="N/A"
          fi
          
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "insertions=${INSERTIONS:-0}" >> $GITHUB_OUTPUT
          echo "deletions=${DELETIONS:-0}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes
        id: notes
        run: |
          cat > release_notes.md << NOTES_EOF
          # git-pm ${{ steps.version.outputs.version }} - Git Package Manager
          
          ## üéâ Release Information
          
          **Version:** ${{ steps.version.outputs.version }}  
          **Release Date:** $(date +%Y-%m-%d)  
          **Repository:** [${{ env.REPO_FULL }}](${{ env.REPO_URL }})  
          **Tag:** [${{ steps.version.outputs.version }}](${{ env.REPO_URL }}/releases/tag/${{ steps.version.outputs.version }})  
          
          ## üìä Statistics
          
          - **Commits:** ${{ steps.stats.outputs.commits }}
          - **Files Changed:** ${{ steps.stats.outputs.files }}
          - **Lines Added:** ${{ steps.stats.outputs.insertions }}
          - **Lines Removed:** ${{ steps.stats.outputs.deletions }}
          
          ## ‚ú® What's New in v0.2.6
          
          ### üîó Nested Dependency Symlinks
          - Automatically creates \\`.git-packages/\\` inside each package
          - Symlinks point to sibling dependencies (\\`../../depName\\`)
          - Same path works in development AND consumption
          - No manual symlink management needed
          
          ### üåç Environment Variables Generation
          - Auto-generates \\`.git-pm.env\\` with absolute paths
          - \\`GIT_PM_PACKAGES_DIR\\` - Root packages directory
          - \\`GIT_PM_PACKAGE_<NAME>\\` - Individual package paths
          - Perfect for scripts, Makefiles, CI/CD
          
          ### ü™ü Windows Symlink Support
          - Intelligent fallback to junction points
          - No admin privileges required
          - Works with or without Developer Mode
          - Both methods work identically with Terraform
          
          ### üìù Automatic .gitignore Management
          - Automatically adds git-pm files on install
          - Never duplicates entries
          - Prevents accidental commits of:
            - \\`.git-packages/\\` (installed dependencies)
            - \\`.git-pm.env\\` (absolute paths)
            - \\`git-pm.local.yaml\\` (local overrides)
            - \\`git-pm.lock\\` (lockfile - optional)
          - Skip with \`--no-gitignore\` flag
          
          ### üöÄ Local Override Discovery
          - Checks local overrides BEFORE cloning
          - No unnecessary remote clones
          - 6x faster installation with overrides
          - Works offline
          - Reads nested dependencies from local paths
          
          ### üéØ Path Resolution
          - Solves path conflicts between dev and consumption
          - Dual approach: symlinks + environment variables
          - Symlinks for Terraform (automatic)
          - Environment variables for scripts (\\`.git-pm.env\\`)
          
          ### Core Features (v0.1-0.2)
          - ‚úÖ Full Dependency Resolution
          - ‚úÖ Explicit Versioning (no ranges)
          - ‚úÖ Branch Auto-Resolution
          - ‚úÖ Independent Versioning
          - ‚úÖ Git Sparse-Checkout
          - ‚úÖ Smart Caching
          - ‚úÖ Cross-Platform (Linux, macOS, Windows)
          - ‚úÖ Azure DevOps Integration
          
          ## üöÄ Quick Start
          
          ### Installation
          
          **Linux/macOS:**
          \`\`\`bash
          curl -fsSL ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.sh | bash
          \`\`\`
          
          **Windows (PowerShell):**
          \`\`\`powershell
          irm ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.ps1 | iex
          \`\`\`
          
          ### Usage
          
          \`\`\`bash
          # Add packages
          git-pm add utils github.com/company/monorepo --path packages/utils --ref-type tag --ref-value v1.0.0
          
          # Install with dependency resolution
          git-pm install
          
          # Update branch-based packages
          git-pm update
          
          # List installed
          git-pm list
          \`\`\`
          
          ## üìã Requirements
          
          - Python 3.8+
          - git
          - Internet connection (for initial install)
          
          ## üìù Changelog
          
          $(cat changelog.txt)
          
          ## üîÑ Migration from Previous Versions
          
          ### Breaking Changes
          1. **Global installation required** - Script no longer in project directory
          2. **Dependency resolution on by default** - Use \`--no-resolve-deps\` to disable
          3. **Local overrides use symlinks** - Faster, live updates
          
          ### Migration Steps
          \`\`\`bash
          # 1. Install globally
          curl -fsSL ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.sh | bash
          
          # 2. Remove old script from project (optional)
          rm git-pm.py
          
          # 3. Works from anywhere now!
          cd your-project
          git-pm install
          \`\`\`
          
          ## üì• Assets
          
          - **git-pm.py** - Main Python script (required by installers)
          - **install-git-pm.sh** - Linux/macOS installer
          - **install-git-pm.ps1** - Windows installer
          
          **Download URL:**
          \`\`\`
          ${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py
          \`\`\`
          
          **Commands after installation:**
          - \`git-pm install\` (via wrapper)
          - \`git-pm.py install\` (direct)
          - \`python git-pm.py install\` (explicit)
          
          ## üêõ Known Issues
          
          - PATH update may require terminal restart
          - Windows installer requires PowerShell 5.0+
          
          ## üìö Documentation
          
          ### Main Documentation
          - [README.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/README.md) - Getting started guide
          - [FEATURES.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/FEATURES.md) - Complete feature reference
          - [DEPENDENCY_RESOLUTION.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/DEPENDENCY_RESOLUTION.md) - How dependency resolution works
          
          ### Feature Guides
          - [NESTED_DEPENDENCY_SYMLINKS.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/NESTED_DEPENDENCY_SYMLINKS.md) - Path resolution with symlinks
          - [ENVIRONMENT_VARIABLES_GUIDE.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/ENVIRONMENT_VARIABLES_GUIDE.md) - Using .git-pm.env
          - [WINDOWS_SYMLINK_SUPPORT.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/WINDOWS_SYMLINK_SUPPORT.md) - Windows compatibility
          - [GITIGNORE_MANAGEMENT.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/GITIGNORE_MANAGEMENT.md) - Automatic .gitignore
          - [LOCAL_OVERRIDE_DISCOVERY_FIX.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/LOCAL_OVERRIDE_DISCOVERY_FIX.md) - Local development
          - [PATH_RESOLUTION_COMPLETE_GUIDE.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/PATH_RESOLUTION_COMPLETE_GUIDE.md) - Path resolution
          
          ### Quick References
          - [WINDOWS_QUICK_GUIDE.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/WINDOWS_QUICK_GUIDE.md) - Windows setup
          - [GITIGNORE_QUICK_REFERENCE.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/GITIGNORE_QUICK_REFERENCE.md) - .gitignore reference
          
          ### CI/CD & Deployment
          - [CI_CD_DOCUMENTATION.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/CI_CD_DOCUMENTATION.md) - CI/CD integration
          - [DEPLOYMENT_GUIDE.md](${{ env.REPO_URL }}/blob/${{ github.ref_name }}/DEPLOYMENT_GUIDE.md) - Deployment instructions
          
          ### Repository
          - [GitHub Repository](${{ env.REPO_URL }})
          - [Issues](${{ env.REPO_URL }}/issues)
          - [Releases](${{ env.REPO_URL }}/releases)
          
          ## üôè Feedback
          
          Please report issues at: [${{ env.REPO_FULL }}/issues](${{ env.REPO_URL }}/issues)
          
          ## üéì Examples
          
          ### Terraform Modules
          \`\`\`yaml
          packages:
            azure-bootstrap:
              repo: dev.azure.com/org/terraform
              path: modules/bootstrap
              ref:
                type: tag
                value: v1.0.0
          \`\`\`
          
          ### Shared Libraries
          \`\`\`yaml
          packages:
            common-utils:
              repo: github.com/company/shared-libs
              path: utils
              ref:
                type: branch
                value: main
          \`\`\`
          
          ### Bitbucket Support
          \`\`\`yaml
          packages:
            my-lib:
              repo: bitbucket.org/workspace/repository
              path: packages/my-lib
              ref:
                type: tag
                value: v1.0.0
          \`\`\`
          
          ## ‚úÖ What's Included
          
          ‚úÖ **Full Dependency Resolution** - Automatic recursive discovery  
          ‚úÖ **Explicit Versioning** - No ranges, exact tags/branches/commits  
          ‚úÖ **Branch Auto-Resolution** - Branches ‚Üí latest commit SHA  
          ‚úÖ **Independent Versioning** - Each package at different commits  
          ‚úÖ **Symlink Local Overrides** - Fast live development  
          ‚úÖ **Azure DevOps PAT** - Built-in token support  
          ‚úÖ **Cross-Platform** - Linux, macOS, Windows  
          ‚úÖ **Zero Dependencies** - Pure Python 3.8+  
          ‚úÖ **Smart Caching** - Fast repeated installs  
          
          ---
          
          **Released by:** @${{ github.actor }}  
          **Commit:** [${{ github.sha }}](${{ env.REPO_URL }}/commit/${{ github.sha }})
          NOTES_EOF
          
          echo "Release notes generated:"
          cat release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: git-pm ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            git-pm.py
            install-git-pm.sh
            install-git-pm.ps1
            README.md
            DEPENDENCY_RESOLUTION.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify release
        run: |
          echo "‚úÖ Release ${{ steps.version.outputs.version }} created successfully!"
          echo ""
          echo "Release URL: ${{ env.REPO_URL }}/releases/tag/${{ steps.version.outputs.version }}"
          echo ""
          echo "Installation command (Linux/macOS):"
          echo "curl -fsSL ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.sh | bash"
          echo ""
          echo "Installation command (Windows):"
          echo "irm ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.ps1 | iex"
          echo ""
          echo "Download URL:"
          echo "${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py"

  test-installation:
    name: Test Release Installation
    needs: create-release
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Wait for release to be available
        shell: bash
        run: |
          echo "Waiting for release to be available..."
          sleep 30
      
      - name: Test Linux/macOS installation
        if: runner.os != 'Windows'
        run: |
          # Test direct download
          curl -fsSL ${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py -o git-pm.py
          
          # Verify downloaded
          if [ -f git-pm.py ]; then
            echo "‚úÖ Downloaded git-pm.py"
          else
            echo "‚ùå Failed to download git-pm.py"
            exit 1
          fi
          
          # Test version
          python3 git-pm.py --version
          
          echo "‚úÖ Release installation test passed on ${{ runner.os }}"
      
      - name: Test Windows installation
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Test direct download
          Invoke-WebRequest -Uri "${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py" -OutFile git-pm.py
          
          # Verify downloaded
          if (Test-Path git-pm.py) {
            Write-Host "‚úÖ Downloaded git-pm.py"
          } else {
            Write-Host "‚ùå Failed to download git-pm.py"
            exit 1
          }
          
          # Test version
          python git-pm.py --version
          
          Write-Host "‚úÖ Release installation test passed on Windows"