name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.2.0)'
        required: true
        type: string

env:
  REPO_OWNER: ${{ github.repository_owner }}
  REPO_NAME: ${{ github.event.repository.name }}
  REPO_FULL: ${{ github.repository }}
  REPO_URL: ${{ github.server_url }}/${{ github.repository }}

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history for changelog
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          
          # Remove 'v' prefix if present
          VERSION_NUM="${VERSION#v}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (Number: $VERSION_NUM)"
      
      - name: Verify version in git-pm.py
        run: |
          SCRIPT_VERSION=$(grep -oP '__version__ = "\K[^"]+' git-pm.py)
          
          if [ "$SCRIPT_VERSION" != "${{ steps.version.outputs.version_num }}" ]; then
            echo "‚ùå Version mismatch!"
            echo "   Script version: $SCRIPT_VERSION"
            echo "   Release version: ${{ steps.version.outputs.version_num }}"
            exit 1
          fi
          
          echo "‚úÖ Version matches: $SCRIPT_VERSION"
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag"
            CHANGELOG="Initial release"
          else
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.version }}"
            
            # Generate commit log
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No changes since $PREV_TAG"
            fi
          fi
          
          # Save to file
          echo "$CHANGELOG" > changelog.txt
          
          echo "Changelog:"
          cat changelog.txt
      
      - name: Pre-release validation
        run: |
          echo "Validating git-pm.py before release..."
          
          # Check syntax
          python3 -m py_compile git-pm.py || exit 1
          echo "‚úÖ Syntax valid"
          
          # Check no lockfile code
          if grep -qi "install_from_lockfile\|save_lockfile\|load_lockfile" git-pm.py; then
            echo "‚ùå Lockfile code found (should be removed)"
            exit 1
          fi
          echo "‚úÖ No lockfile code"
          
          # Check no removed commands
          if grep -q "def cmd_update\|def cmd_list\|def cmd_verify" git-pm.py; then
            echo "‚ùå Removed commands found"
            exit 1
          fi
          echo "‚úÖ No removed commands"
          
          # Check that remove command exists (v0.3.0+)
          if ! grep -q "def cmd_remove" git-pm.py; then
            echo "‚ùå Remove command not found (required for v0.3.0+)"
            exit 1
          fi
          echo "‚úÖ Remove command present"
          
          # Check that config command exists (v0.4.0+)
          if ! grep -q "def cmd_config" git-pm.py; then
            echo "‚ùå Config command not found (required for v0.4.0+)"
            exit 1
          fi
          echo "‚úÖ Config command present"
          
          # Check Azure DevOps URL handling methods exist (v0.5.0+)
          if ! grep -q "_parse_azure_devops_url" git-pm.py; then
            echo "‚ö†Ô∏è  Azure DevOps URL parser not found (optional for v0.5.0+)"
          else
            echo "‚úÖ Azure DevOps URL parser present"
          fi
          
          if ! grep -q "_build_azure_devops_url" git-pm.py; then
            echo "‚ö†Ô∏è  Azure DevOps URL builder not found (optional for v0.5.0+)"
          else
            echo "‚úÖ Azure DevOps URL builder present"
          fi
          
          if ! grep -q "_configure_azure_devops_auth" git-pm.py; then
            echo "‚ö†Ô∏è  Azure DevOps auth config not found (optional for v0.5.0+)"
          else
            echo "‚úÖ Azure DevOps auth config present"
          fi
          
          # Test basic commands
          python3 git-pm.py --version || exit 1
          python3 git-pm.py --help | grep -q "install.*clean.*remove.*config.*add" || exit 1
          echo "‚úÖ Commands work (install, clean, remove, config, add)"
          
          # Test remove command specifically
          python3 git-pm.py remove --help | grep -q "package" || exit 1
          echo "‚úÖ Remove command functional"
          
          # Test config command specifically
          python3 git-pm.py config --help | grep -q "Configuration key" || exit 1
          echo "‚úÖ Config command functional"
          
          echo "‚úÖ Pre-release validation passed"
      
      - name: Get commit statistics
        id: stats
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git rev-list ${PREV_TAG}..HEAD --count)
            FILES_CHANGED=$(git diff --name-only ${PREV_TAG}..HEAD | wc -l)
            INSERTIONS=$(git diff ${PREV_TAG}..HEAD --shortstat | grep -oP '\d+(?= insertion)')
            DELETIONS=$(git diff ${PREV_TAG}..HEAD --shortstat | grep -oP '\d+(?= deletion)')
          else
            COMMITS=$(git rev-list HEAD --count)
            FILES_CHANGED="N/A"
            INSERTIONS="N/A"
            DELETIONS="N/A"
          fi
          
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "insertions=${INSERTIONS:-0}" >> $GITHUB_OUTPUT
          echo "deletions=${DELETIONS:-0}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes
        id: notes
        run: |
          RELEASE_DATE=$(date +%Y-%m-%d)
          cat > release_notes.md << 'NOTES_EOF'
          # git-pm ${{ steps.version.outputs.version }} - Git Package Manager
          
          ## üéâ Release Information
          
          **Version:** ${{ steps.version.outputs.version }}  
          **Release Date:** RELEASE_DATE_PLACEHOLDER  
          **Repository:** [${{ env.REPO_FULL }}](${{ env.REPO_URL }})  
          **Tag:** [${{ steps.version.outputs.version }}](${{ env.REPO_URL }}/releases/tag/${{ steps.version.outputs.version }})  
          
          ## üìä Statistics
          
          - **Commits:** ${{ steps.stats.outputs.commits }}
          - **Files Changed:** ${{ steps.stats.outputs.files }}
          - **Lines Added:** ${{ steps.stats.outputs.insertions }}
          - **Lines Removed:** ${{ steps.stats.outputs.deletions }}
          
          ## ‚ú® What's New
          
          ### üîê Enhanced CI/CD Authentication
          
          This release adds comprehensive **Azure DevOps URL handling** and **multi-provider authentication** support for seamless CI/CD pipeline integration.
          
          #### New Authentication Methods
          
          | Method | Environment Variable | Best For |
          |--------|---------------------|----------|
          | Azure DevOps Bearer | `SYSTEM_ACCESSTOKEN` | Azure Pipelines (recommended) |
          | Azure DevOps PAT | `AZURE_DEVOPS_PAT` | Simple setup |
          | GitHub | `GIT_PM_TOKEN_github_com` | GitHub Actions |
          | GitLab | `GIT_PM_TOKEN_gitlab_com` | GitLab CI |
          | Bitbucket | `GIT_PM_TOKEN_bitbucket_org` | Bitbucket Pipelines |
          | Any Provider | `GIT_PM_TOKEN_{domain}` | Self-hosted/other |
          
          #### Azure DevOps URL Normalization
          
          All Azure DevOps URL formats are now automatically normalized:
          
          ```
          ‚úÖ git@ssh.dev.azure.com:v3/org/project/repo
          ‚úÖ https://dev.azure.com/org/project/_git/repo
          ‚úÖ https://user@dev.azure.com/org/project/_git/repo
          ‚úÖ dev.azure.com/org/project/_git/repo
          ‚úÖ dev.azure.com/org/project/repo
          ‚úÖ dev.azure.com:v3/org/project/repo (legacy)
          ```
          
          #### Seamless Local & CI/CD Development
          
          Use the same `git-pm.json` for both environments:
          
          ```json
          {
            "packages": {
              "shared-scripts": {
                "repo": "dev.azure.com/myorg/Platform/shared-scripts",
                "path": "utils",
                "ref": {"type": "tag", "value": "v1.0.0"}
              }
            }
          }
          ```
          
          - **Local:** Automatically uses SSH (if keys configured)
          - **CI/CD:** Automatically uses HTTPS with token authentication
          
          ### üîß Azure Pipelines Integration
          
          **Recommended Setup (SYSTEM_ACCESSTOKEN):**
          
          ```yaml
          - task: Bash@3
            displayName: 'Install packages'
            inputs:
              targetType: 'inline'
              script: |
                curl -fsSL ${{ env.REPO_URL }}/releases/latest/download/install-git-pm.sh | bash
                git-pm install
            env:
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)
          ```
          
          **Benefits:**
          - ‚úÖ Token never appears in URLs or logs
          - ‚úÖ Uses git `http.extraheader` with bearer authentication
          - ‚úÖ Automatic cross-project access (with proper permissions)
          
          ### üõ†Ô∏è GitHub Actions Integration
          
          ```yaml
          - name: Install packages
            run: |
              curl -fsSL ${{ env.REPO_URL }}/releases/latest/download/install-git-pm.sh | bash
              git-pm install
            env:
              GIT_PM_TOKEN_github_com: ${{ secrets.GITHUB_TOKEN }}
          ```
          
          ### üìÅ Local Override Workflow
          
          Use `git-pm.local` for local development without modifying committed files:
          
          ```json
          {
            "packages": {
              "shared-scripts": {
                "repo": "file:///home/dev/projects/shared-scripts"
              }
            }
          }
          ```
          
          ## üöÄ Quick Start
          
          **Linux/macOS:**
          ```bash
          curl -fsSL ${{ env.REPO_URL }}/releases/latest/download/install-git-pm.sh | bash
          ```
          
          **Windows:**
          ```powershell
          irm ${{ env.REPO_URL }}/releases/latest/download/install-git-pm.ps1 | iex
          ```
          
          **Direct Download:**
          ```bash
          curl -fsSL ${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py -o git-pm.py
          python3 git-pm.py install
          ```
          
          ## üìñ Usage
          
          ### Basic Commands
          
          ```bash
          # Install packages from manifest
          git-pm install
          
          # Remove a package (with dependency analysis)
          git-pm remove <package-name>
          
          # Clean all installed packages
          git-pm clean
          
          # Manage configuration
          git-pm config --list
          git-pm config packages_dir ".deps"
          git-pm config --global git_protocol '{"dev.azure.com": "https"}'
          
          # Add a package to manifest
          git-pm add my-pkg github.com/org/repo --path src --ref-type tag --ref-value v1.0.0
          ```
          
          ### Configuration Hierarchy
          
          ```
          Defaults ‚Üí User Config (~/.git-pm/config) ‚Üí Project Config (git-pm.config) ‚Üí Environment Variables
          ```
          
          | Key | Description | Default |
          |-----|-------------|---------|
          | `packages_dir` | Installation directory | `.git-packages` |
          | `cache_dir` | Cache location | `~/.cache/git-pm` |
          | `git_protocol` | Protocol per domain | `{}` |
          | `azure_devops_pat` | Azure DevOps PAT | `""` |
          
          ## üìã Manifest Format (JSON)
          
          ```json
          {
            "packages": {
              "azure-bootstrap": {
                "repo": "dev.azure.com/org/project/terraform-modules",
                "path": "modules/bootstrap",
                "ref": {
                  "type": "tag",
                  "value": "v1.0.0"
                }
              },
              "common-utils": {
                "repo": "github.com/company/shared-libs",
                "path": "utils",
                "ref": {
                  "type": "branch",
                  "value": "main"
                }
              }
            }
          }
          ```
          
          ## üìö Core Features
          
          ‚úÖ **Multi-Provider Authentication** - GitHub, GitLab, Bitbucket, Azure DevOps  
          ‚úÖ **Azure DevOps URL Handling** - All URL formats supported  
          ‚úÖ **SYSTEM_ACCESSTOKEN Support** - Secure bearer token auth for Azure Pipelines  
          ‚úÖ **Protocol-Agnostic Repos** - Same manifest for local SSH and CI/CD HTTPS  
          ‚úÖ **Dependency Resolution** - Automatic recursive discovery  
          ‚úÖ **Explicit Versioning** - Tags, branches, or commits  
          ‚úÖ **Configuration Management** - CLI config with precedence  
          ‚úÖ **Package Removal** - Smart cascade with preservation  
          ‚úÖ **Local Overrides** - Fast development with `git-pm.local`  
          ‚úÖ **Smart Caching** - Fast repeated installs  
          ‚úÖ **Cross-Platform** - Linux, macOS, Windows  
          ‚úÖ **Zero Dependencies** - Pure Python 3.8+  
          
          ## üîê Authentication Quick Reference
          
          | Scenario | Environment Variable |
          |----------|---------------------|
          | Azure Pipelines | `SYSTEM_ACCESSTOKEN: $(System.AccessToken)` |
          | Azure DevOps (PAT) | `AZURE_DEVOPS_PAT: your-pat-token` |
          | GitHub Actions | `GIT_PM_TOKEN_github_com: ${{ secrets.GITHUB_TOKEN }}` |
          | GitLab CI | `GIT_PM_TOKEN_gitlab_com: ${CI_JOB_TOKEN}` |
          | Bitbucket Pipelines | `GIT_PM_TOKEN_bitbucket_org: ${BITBUCKET_TOKEN}` |
          | Self-hosted | `GIT_PM_TOKEN_git_mycompany_com: ${TOKEN}` |
          
          ## üìã Requirements
          
          - Python 3.8+
          - Git 2.25+
          - Internet connection (for remote repos)
          
          ## üéì CI/CD Examples
          
          ### Azure DevOps Pipeline
          
          ```yaml
          trigger:
            - main
          
          pool:
            vmImage: 'ubuntu-latest'
          
          steps:
            - task: Bash@3
              displayName: 'Install dependencies'
              inputs:
                targetType: 'inline'
                script: |
                  curl -fsSL ${{ env.REPO_URL }}/releases/latest/download/install-git-pm.sh | bash
                  git-pm install
              env:
                SYSTEM_ACCESSTOKEN: $(System.AccessToken)
          ```
          
          ### GitHub Actions
          
          ```yaml
          jobs:
            build:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Install packages
                  run: |
                    curl -fsSL ${{ env.REPO_URL }}/releases/latest/download/install-git-pm.sh | bash
                    git-pm install
                  env:
                    GIT_PM_TOKEN_github_com: ${{ secrets.GITHUB_TOKEN }}
          ```
          
          ### GitLab CI
          
          ```yaml
          build:
            script:
              - curl -fsSL ${{ env.REPO_URL }}/releases/latest/download/install-git-pm.sh | bash
              - git-pm install
            variables:
              GIT_PM_TOKEN_gitlab_com: ${CI_JOB_TOKEN}
          ```
          
          ## üìö Documentation
          
          - [README](${{ env.REPO_URL }}/blob/main/README.md)
          - [CI/CD Documentation](${{ env.REPO_URL }}/blob/main/CI_CD_DOCUMENTATION.md)
          - [Dependency Resolution](${{ env.REPO_URL }}/blob/main/DEPENDENCY_RESOLUTION.md)
          
          ## üîÑ Previous Releases
          
          **v0.4.x** - Config command with CLI-based configuration management  
          **v0.3.x** - Remove command with intelligent dependency management  
          **v0.2.x** - Dependency resolution with explicit versioning  
          
          ## üôè Feedback
          
          Please report issues at: [${{ env.REPO_FULL }}/issues](${{ env.REPO_URL }}/issues)
          
          ---
          
          **Released by:** @${{ github.actor }}  
          **Commit:** [${{ github.sha }}](${{ env.REPO_URL }}/commit/${{ github.sha }})
          NOTES_EOF
          
          # Replace the date placeholder with actual date
          sed -i "s/RELEASE_DATE_PLACEHOLDER/$RELEASE_DATE/g" release_notes.md
          
          echo "Release notes generated:"
          cat release_notes.md

      - name: Prepare release assets
        id: assets
        run: |
          echo "Preparing release assets..."
          
          # Start with required files
          ASSETS="git-pm.py"
          
          # Add optional files if they exist
          [ -f "README.md" ] && ASSETS="$ASSETS README.md" || echo "‚ö†Ô∏è  README.md not found"
          [ -f "install-git-pm.sh" ] && ASSETS="$ASSETS install-git-pm.sh" || echo "‚ö†Ô∏è  install-git-pm.sh not found"
          [ -f "install-git-pm.ps1" ] && ASSETS="$ASSETS install-git-pm.ps1" || echo "‚ö†Ô∏è  install-git-pm.ps1 not found"
          [ -f "CI_CD_DOCUMENTATION.md" ] && ASSETS="$ASSETS CI_CD_DOCUMENTATION.md" || echo "‚ö†Ô∏è  CI_CD_DOCUMENTATION.md not found"
          
          # Create files list for GitHub release action
          echo "$ASSETS" | tr ' ' '\n' > release_assets.txt
          
          echo "Assets to upload:"
          cat release_assets.txt
          
          # Export for next step
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat release_assets.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: git-pm ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: ${{ steps.assets.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify release
        run: |
          echo "‚úÖ Release ${{ steps.version.outputs.version }} created successfully!"
          echo ""
          echo "Release URL: ${{ env.REPO_URL }}/releases/tag/${{ steps.version.outputs.version }}"
          echo ""
          echo "Installation command (Linux/macOS):"
          echo "curl -fsSL ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.sh | bash"
          echo ""
          echo "Installation command (Windows):"
          echo "irm ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.ps1 | iex"
          echo ""
          echo "Download URL:"
          echo "${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py"

  test-installation:
    name: Test Release Installation
    needs: create-release
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Wait for release to be available
        shell: bash
        run: |
          echo "Waiting for release to be available..."
          sleep 30
      
      - name: Test Linux/macOS installation
        if: runner.os != 'Windows'
        run: |
          # Test direct download
          curl -fsSL ${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py -o git-pm.py
          
          # Verify downloaded
          if [ -f git-pm.py ]; then
            echo "‚úÖ Downloaded git-pm.py"
          else
            echo "‚ùå Failed to download git-pm.py"
            exit 1
          fi
          
          # Test version
          python3 git-pm.py --version
          
          # Test help includes all commands
          python3 git-pm.py --help | grep -q "install" && echo "‚úÖ install command present"
          python3 git-pm.py --help | grep -q "config" && echo "‚úÖ config command present"
          python3 git-pm.py --help | grep -q "remove" && echo "‚úÖ remove command present"
          
          echo "‚úÖ Release installation test passed on ${{ runner.os }}"
      
      - name: Test Windows installation
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Test direct download
          Invoke-WebRequest -Uri "${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py" -OutFile git-pm.py
          
          # Verify downloaded
          if (Test-Path git-pm.py) {
            Write-Host "‚úÖ Downloaded git-pm.py"
          } else {
            Write-Host "‚ùå Failed to download git-pm.py"
            exit 1
          }
          
          # Test version
          python git-pm.py --version
          
          Write-Host "‚úÖ Release installation test passed on Windows"

  test-authentication:
    name: Test Authentication Features
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Wait for release
        run: sleep 30
      
      - name: Download and test
        run: |
          curl -fsSL ${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py -o git-pm.py
          
          echo "Testing authentication-related features..."
          
          # Check Azure DevOps URL handling methods exist
          if grep -q "_parse_azure_devops_url" git-pm.py; then
            echo "‚úÖ Azure DevOps URL parser present"
          else
            echo "‚ö†Ô∏è  Azure DevOps URL parser not found (may be older version)"
          fi
          
          if grep -q "_build_azure_devops_url" git-pm.py; then
            echo "‚úÖ Azure DevOps URL builder present"
          else
            echo "‚ö†Ô∏è  Azure DevOps URL builder not found (may be older version)"
          fi
          
          if grep -q "_configure_azure_devops_auth" git-pm.py; then
            echo "‚úÖ Azure DevOps bearer auth configuration present"
          else
            echo "‚ö†Ô∏è  Azure DevOps bearer auth not found (may be older version)"
          fi
          
          if grep -q "SYSTEM_ACCESSTOKEN" git-pm.py; then
            echo "‚úÖ SYSTEM_ACCESSTOKEN support present"
          else
            echo "‚ö†Ô∏è  SYSTEM_ACCESSTOKEN support not found (may be older version)"
          fi
          
          # Check config command exists
          if grep -q "def cmd_config" git-pm.py; then
            echo "‚úÖ Config command present"
          else
            echo "‚ùå Config command missing"
            exit 1
          fi
          
          echo "‚úÖ Authentication feature check complete"