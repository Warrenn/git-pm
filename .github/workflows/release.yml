name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.2.0)'
        required: true
        type: string

env:
  REPO_OWNER: ${{ github.repository_owner }}
  REPO_NAME: ${{ github.event.repository.name }}
  REPO_FULL: ${{ github.repository }}
  REPO_URL: ${{ github.server_url }}/${{ github.repository }}

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history for changelog
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          
          # Remove 'v' prefix if present
          VERSION_NUM="${VERSION#v}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (Number: $VERSION_NUM)"
      
      - name: Verify version in git-pm.py
        run: |
          SCRIPT_VERSION=$(grep -oP '__version__ = "\K[^"]+' git-pm.py)
          
          if [ "$SCRIPT_VERSION" != "${{ steps.version.outputs.version_num }}" ]; then
            echo "âŒ Version mismatch!"
            echo "   Script version: $SCRIPT_VERSION"
            echo "   Release version: ${{ steps.version.outputs.version_num }}"
            exit 1
          fi
          
          echo "âœ… Version matches: $SCRIPT_VERSION"
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag"
            CHANGELOG="Initial release"
          else
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.version }}"
            
            # Generate commit log
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No changes since $PREV_TAG"
            fi
          fi
          
          # Save to file
          echo "$CHANGELOG" > changelog.txt
          
          echo "Changelog:"
          cat changelog.txt
      
      - name: Pre-release validation
        run: |
          echo "Validating git-pm.py before release..."
          
          # Check syntax
          python3 -m py_compile git-pm.py || exit 1
          echo "âœ… Syntax valid"
          
          # Check no lockfile code
          if grep -qi "install_from_lockfile\|save_lockfile\|load_lockfile" git-pm.py; then
            echo "âŒ Lockfile code found (should be removed)"
            exit 1
          fi
          echo "âœ… No lockfile code"
          
          # Check no removed commands
          if grep -q "def cmd_update\|def cmd_list\|def cmd_verify" git-pm.py; then
            echo "âŒ Removed commands found"
            exit 1
          fi
          echo "âœ… No removed commands"
          
          # Check that remove command exists (v0.3.0+)
          if ! grep -q "def cmd_remove" git-pm.py; then
            echo "âŒ Remove command not found (required for v0.3.0+)"
            exit 1
          fi
          echo "âœ… Remove command present"
          
          # Test basic commands
          python3 git-pm.py --version || exit 1
          python3 git-pm.py --help | grep -q "install.*clean.*remove.*add" || exit 1
          echo "âœ… Commands work (install, clean, remove, add)"
          
          # Test remove command specifically
          python3 git-pm.py remove --help | grep -q "package" || exit 1
          echo "âœ… Remove command functional"
          
          echo "âœ… Pre-release validation passed"
      
      - name: Get commit statistics
        id: stats
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git rev-list ${PREV_TAG}..HEAD --count)
            FILES_CHANGED=$(git diff --name-only ${PREV_TAG}..HEAD | wc -l)
            INSERTIONS=$(git diff ${PREV_TAG}..HEAD --shortstat | grep -oP '\d+(?= insertion)')
            DELETIONS=$(git diff ${PREV_TAG}..HEAD --shortstat | grep -oP '\d+(?= deletion)')
          else
            COMMITS=$(git rev-list HEAD --count)
            FILES_CHANGED="N/A"
            INSERTIONS="N/A"
            DELETIONS="N/A"
          fi
          
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "insertions=${INSERTIONS:-0}" >> $GITHUB_OUTPUT
          echo "deletions=${DELETIONS:-0}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'NOTES_EOF'
          # git-pm ${{ steps.version.outputs.version }} - Git Package Manager
          
          ## ğŸ‰ Release Information
          
          **Version:** ${{ steps.version.outputs.version }}  
          **Release Date:** $(date +%Y-%m-%d)  
          **Repository:** [${{ env.REPO_FULL }}](${{ env.REPO_URL }})  
          **Tag:** [${{ steps.version.outputs.version }}](${{ env.REPO_URL }}/releases/tag/${{ steps.version.outputs.version }})  
          
          ## ğŸ“Š Statistics
          
          - **Commits:** ${{ steps.stats.outputs.commits }}
          - **Files Changed:** ${{ steps.stats.outputs.files }}
          - **Lines Added:** ${{ steps.stats.outputs.insertions }}
          - **Lines Removed:** ${{ steps.stats.outputs.deletions }}
          
          ## âœ¨ What's New in v0.3.0
          
          ### ğŸ—‘ï¸ New Feature: Remove Command
          
          This release adds the highly-requested **`remove` command** with intelligent dependency management and deep recursion analysis!
          
          **New Command:**
          ```bash
          git-pm remove <package-name> [-y]
          ```
          
          ### ğŸ¯ Key Features
          
          - âœ… **Smart dependency cascade** - Automatically removes unused dependencies
          - âœ… **Deep recursion analysis** - Analyzes dependencies at any depth (3+ levels)
          - âœ… **Preserves shared dependencies** - Never breaks other packages
          - âœ… **Multi-path detection** - Correctly handles packages referenced multiple ways
          - âœ… **Dual manifest support** - Removes from both git-pm.json and git-pm.local
          - âœ… **Environment file cleanup** - Updates .git-pm.env automatically
          - âœ… **Preview before removal** - Shows what will be removed (unless -y flag)
          - âœ… **Safe by design** - No --force flag, never breaks dependencies
          
          ### ğŸ“– How It Works
          
          **Example Dependency Tree:**
          ```
          project
          â”œâ”€â”€ pkg-a â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   â”œâ”€â”€ pkg-b â”€â”€â”€â” â”‚
          â”‚   â”‚   â””â”€â”€ pkg-d â”‚  â† Shared dependency!
          â”‚   â””â”€â”€ pkg-c â”€â”€â”€â”¤ â”‚
          â”‚       â””â”€â”€ pkg-d â”‚
          â””â”€â”€ pkg-x â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â””â”€â”€ pkg-d
          ```
          
          **Remove pkg-a:**
          ```bash
          $ git-pm remove pkg-a
          
          ğŸ“¦ Removal plan:
            âœ“ Remove pkg-a (explicitly requested)
            âœ“ Remove pkg-b (only needed by pkg-a)
            âœ“ Remove pkg-c (only needed by pkg-a)
            âœ“ Keep pkg-d (still needed by pkg-x)
            âœ“ Keep pkg-x (still in manifest)
          
          Proceed? (y/N): y
          
          âœ… Successfully removed 'pkg-a'
             Removed 3 packages from disk
          ```
          
          **Result:** pkg-a, pkg-b, and pkg-c removed. pkg-d and pkg-x preserved (still needed).
          
          ### ğŸ›¡ï¸ Safety Features
          
          - âœ… Never breaks dependencies
          - âœ… Shows preview before removing
          - âœ… Requires confirmation (unless -y)
          - âœ… Preserves packages in use
          - âœ… Handles circular dependencies
          - âœ… Works with nested symlinks
          - âœ… No --force flag (intentional)
          
          ### ğŸ”§ What Remove Does
          
          1. **Analyzes dependencies** - Recursively discovers what will remain
          2. **Removes from manifests** - Updates git-pm.json and git-pm.local
          3. **Removes from disk** - Only packages no longer needed
          4. **Updates environment** - Cleans .git-pm.env entries
          5. **Preserves cache** - Never touches ~/.cache/git-pm/
          
          ### ğŸ“‹ Remove Command Options
          
          | Option | Description |
          |--------|-------------|
          | `-y, --yes` | Skip confirmation prompt |
          | `-h, --help` | Show help message |
          
          ### ğŸ“š Example Scenarios
          
          **Remove unused package:**
          ```bash
          git-pm remove old-package -y
          ```
          
          **Remove package with dependencies:**
          ```bash
          git-pm remove parent-package
          # Automatically removes child packages if not needed elsewhere
          ```
          
          **Remove from both manifests:**
          ```bash
          git-pm remove override-package -y
          # Removes from git-pm.json AND git-pm.local
          ```
          
          ## ğŸš€ Quick Start
          
          ### Available Commands (Updated for v0.3.0)
          
          ```bash
          git-pm install [--no-gitignore]    # Install packages with dependency resolution
          git-pm clean                        # Remove all installed packages
          git-pm remove <pkg> [-y]            # Remove specific package (NEW!)
          git-pm add <n> <repo> [opts]  # Add package to manifest
          ```
          
          ### Example Usage
          
          ```bash
          # Add a package (JSON format)
          git-pm add utils github.com/company/monorepo \
            --path packages/utils \
            --ref-type tag \
            --ref-value v1.0.0
          
          # Install with automatic dependency resolution
          git-pm install
          
          # Remove a specific package
          git-pm remove utils -y
          
          # Clean all packages
          git-pm clean
          ```
          
          ## ğŸ“‹ Manifest Format (JSON)
          
          ```json
          {
            "packages": {
              "azure-bootstrap": {
                "repo": "dev.azure.com/org/terraform",
                "path": "modules/bootstrap",
                "ref": {
                  "type": "tag",
                  "value": "v1.0.0"
                }
              },
              "common-utils": {
                "repo": "github.com/company/shared-libs",
                "path": "utils",
                "ref": {
                  "type": "branch",
                  "value": "main"
                }
              }
            }
          }
          ```
          
          ## ğŸ“š Core Features (Complete Set)
          
          âœ… **Dependency Resolution** - Automatic recursive discovery  
          âœ… **Explicit Versioning** - Tags, branches, or commits  
          âœ… **Package Removal** - Smart cascade with preservation (NEW!)  
          âœ… **Local Overrides** - Fast development with `git-pm.local`  
          âœ… **Smart Caching** - Fast repeated installs  
          âœ… **Cross-Platform** - Linux, macOS, Windows  
          âœ… **Zero Dependencies** - Pure Python 3.8+  
          âœ… **Azure DevOps PAT** - Built-in token support  
          
          ## ğŸ“‹ Requirements
          
          - Python 3.8+
          - Git 2.25+
          - Internet connection (for remote repos)
          
          ## ğŸ“ Examples
          
          ### Terraform Modules
          ```json
          {
            "packages": {
              "azure-bootstrap": {
                "repo": "dev.azure.com/org/terraform",
                "path": "modules/bootstrap",
                "ref": {"type": "tag", "value": "v1.0.0"}
              }
            }
          }
          ```
          
          ### Shared Libraries
          ```json
          {
            "packages": {
              "common-utils": {
                "repo": "github.com/company/shared-libs",
                "path": "utils",
                "ref": {"type": "branch", "value": "main"}
              }
            }
          }
          ```
          
          ### Bitbucket Support
          ```json
          {
            "packages": {
              "my-lib": {
                "repo": "bitbucket.org/workspace/repository",
                "path": "packages/my-lib",
                "ref": {"type": "tag", "value": "v1.0.0"}
              }
            }
          }
          ```
          
          ## ğŸ”„ Previous Release (v0.2.9)
          
          v0.2.9 removed the lockfile system and simplified git-pm:
          - Removed lockfile system (git-pm.lock)
          - Removed `git-pm update` command
          - Removed `--force-fresh` and `--no-resolve-deps` flags
          - 23.8% smaller codebase
          - Use commit refs for reproducibility instead of lockfile
          
          ## ğŸ™ Feedback
          ## ğŸ™ Feedback
          
          Please report issues at: [${{ env.REPO_FULL }}/issues](${{ env.REPO_URL }}/issues)
          
          ---
          
          **Released by:** @${{ github.actor }}  
          **Commit:** [${{ github.sha }}](${{ env.REPO_URL }}/commit/${{ github.sha }})
          NOTES_EOF
          
          echo "Release notes generated:"
          cat release_notes.md

      - name: Prepare release assets
        id: assets
        run: |
          echo "Preparing release assets..."
          
          # Start with required files
          ASSETS="git-pm.py"
          
          # Add optional files if they exist
          [ -f "README.md" ] && ASSETS="$ASSETS README.md" || echo "âš ï¸  README.md not found"
          [ -f "install-git-pm.sh" ] && ASSETS="$ASSETS install-git-pm.sh" || echo "âš ï¸  install-git-pm.sh not found"
          [ -f "install-git-pm.ps1" ] && ASSETS="$ASSETS install-git-pm.ps1" || echo "âš ï¸  install-git-pm.ps1 not found"
          
          # Create files list for GitHub release action
          echo "$ASSETS" | tr ' ' '\n' > release_assets.txt
          
          echo "Assets to upload:"
          cat release_assets.txt
          
          # Export for next step
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat release_assets.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: git-pm ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: ${{ steps.assets.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify release
        run: |
          echo "âœ… Release ${{ steps.version.outputs.version }} created successfully!"
          echo ""
          echo "Release URL: ${{ env.REPO_URL }}/releases/tag/${{ steps.version.outputs.version }}"
          echo ""
          echo "Installation command (Linux/macOS):"
          echo "curl -fsSL ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.sh | bash"
          echo ""
          echo "Installation command (Windows):"
          echo "irm ${{ env.REPO_URL }}/raw/${{ github.ref_name }}/install-git-pm.ps1 | iex"
          echo ""
          echo "Download URL:"
          echo "${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py"

  test-installation:
    name: Test Release Installation
    needs: create-release
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Wait for release to be available
        shell: bash
        run: |
          echo "Waiting for release to be available..."
          sleep 30
      
      - name: Test Linux/macOS installation
        if: runner.os != 'Windows'
        run: |
          # Test direct download
          curl -fsSL ${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py -o git-pm.py
          
          # Verify downloaded
          if [ -f git-pm.py ]; then
            echo "âœ… Downloaded git-pm.py"
          else
            echo "âŒ Failed to download git-pm.py"
            exit 1
          fi
          
          # Test version
          python3 git-pm.py --version
          
          echo "âœ… Release installation test passed on ${{ runner.os }}"
      
      - name: Test Windows installation
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Test direct download
          Invoke-WebRequest -Uri "${{ env.REPO_URL }}/releases/download/${{ steps.version.outputs.version }}/git-pm.py" -OutFile git-pm.py
          
          # Verify downloaded
          if (Test-Path git-pm.py) {
            Write-Host "âœ… Downloaded git-pm.py"
          } else {
            Write-Host "âŒ Failed to download git-pm.py"
            exit 1
          }
          
          # Test version
          python git-pm.py --version
          
          Write-Host "âœ… Release installation test passed on Windows"